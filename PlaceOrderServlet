package LoginServletUni;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;
import javax.servlet.annotation.*;
import java.sql.*;
import org.json.*;
import util.DBConnection;

public class PlaceOrderServlet extends HttpServlet {

    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {

        response.setContentType("text/html;charset=UTF-8");
        PrintWriter out = response.getWriter();

        String cartData = request.getParameter("cartData");
        HttpSession session = request.getSession(false);

        if (session == null || session.getAttribute("username") == null) {
            response.sendRedirect("customer_login.jsp");
            return;
        }

        String username = (String) session.getAttribute("username");

        try (Connection conn = DBConnection.createConnection()) {

            // 1. Get custID from username
            PreparedStatement userStmt = conn.prepareStatement("SELECT custID FROM CUSTOMERS WHERE username = ?");
            userStmt.setString(1, username);
            ResultSet rs = userStmt.executeQuery();

            int custID = -1;
            if (rs.next()) {
                custID = rs.getInt("custID");
            } else {
                out.println("User not found");
                return;
            }

            // 2. Insert into ORDERS table
            PreparedStatement orderStmt = conn.prepareStatement(
                "INSERT INTO ORDERS (custID, totalPrice, orderDate, orderStatus) VALUES (?, ?, CURRENT_DATE, ?)",
                Statement.RETURN_GENERATED_KEYS);

            // Calculate total from cart
            double totalPrice = 0.0;
            JSONArray cartItems = new JSONArray(cartData);
            for (int i = 0; i < cartItems.length(); i++) {
                JSONObject item = cartItems.getJSONObject(i);
                double price = item.getDouble("price");
                int qty = item.getInt("quantity");
                totalPrice += price * qty;
            }

            orderStmt.setInt(1, custID);
            orderStmt.setDouble(2, totalPrice);
            orderStmt.setString(3, "Pending");
            orderStmt.executeUpdate();

            ResultSet orderRs = orderStmt.getGeneratedKeys();
            int orderID = -1;
            if (orderRs.next()) {
                orderID = orderRs.getInt(1);
            }

            // 3. Insert into ORDER_MERCH table
            PreparedStatement itemStmt = conn.prepareStatement(
                "INSERT INTO ORDER_MERCH (custID, orderID, merchID, merchQty) VALUES (?, ?, ?, ?)");

            for (int i = 0; i < cartItems.length(); i++) {
                JSONObject item = cartItems.getJSONObject(i);
                int merchID = item.getInt("merchID");
                int qty = item.getInt("quantity");

                itemStmt.setInt(1, custID);
                itemStmt.setInt(2, orderID);
                itemStmt.setInt(3, merchID);
                itemStmt.setInt(4, qty);
                itemStmt.addBatch();
            }

            itemStmt.executeBatch();

            // 4. Redirect to summary page
            session.setAttribute("orderID", orderID);
            response.sendRedirect("orderSummary.jsp");

        } catch (Exception e) {
            out.println("Error: " + e.getMessage());
        }
    }
}
